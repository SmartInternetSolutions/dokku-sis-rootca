#!/usr/bin/env bash

set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

APP="$1"; IMAGE="dokku/$APP"
echo "-----> Installing SIS RootCA ..."

DIR=/app

COMMAND=$(cat <<EOF

cat > /usr/local/share/ca-certificates/SIS-RootCA.crt <<EOF2
-----BEGIN CERTIFICATE-----
MIIGcDCCBFigAwIBAgIJAKX4H5IPv7PpMA0GCSqGSIb3DQEBCwUAMIHHMQswCQYD
VQQGEwJERTEPMA0GA1UECAwGQmF5ZXJuMRIwEAYDVQQHDAlOdWVybmJlcmcxOjA4
BgNVBAoMMVNtYXJ0IEludGVybmV0IFNvbHV0aW9ucyBVRyAoaGFmdHVuZ3NiZXNj
aHJhZW5rdCkxFDASBgNVBAsMC1Jvb3RDQSAyMDE1MRkwFwYDVQQDDBBzbWFydGlu
dGVybmV0LmV1MSYwJAYJKoZIhvcNAQkBFhdyb290Y2FAc21hcnRpbnRlcm5ldC5l
dTAeFw0xNDEyMTQxNDMyNDVaFw0yNDEyMTExNDMyNDVaMIHHMQswCQYDVQQGEwJE
RTEPMA0GA1UECAwGQmF5ZXJuMRIwEAYDVQQHDAlOdWVybmJlcmcxOjA4BgNVBAoM
MVNtYXJ0IEludGVybmV0IFNvbHV0aW9ucyBVRyAoaGFmdHVuZ3NiZXNjaHJhZW5r
dCkxFDASBgNVBAsMC1Jvb3RDQSAyMDE1MRkwFwYDVQQDDBBzbWFydGludGVybmV0
LmV1MSYwJAYJKoZIhvcNAQkBFhdyb290Y2FAc21hcnRpbnRlcm5ldC5ldTCCAiIw
DQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAMCufa4bRrZkTaKRXvITsapRgWZv
ajwA2kTFhWUHDN63q0qqdUgxjBOFTBS0R9duPrOpgKU+POScClGOtc2z6BxD7LEQ
TrM4kLW4IdaN3XLOGqVDTHv6I6LTK3sW66pndaHbzKBleM8upzag4wRCEgZA3UU6
fMEQKSHHccydxlaZZN6v1ztUt1NGJPRp65EsoJDw9mOvtO70eKFijscw8nuygYiw
tiTORgTtYfBN/PmD0r0L8WPgFG7hR78kik6VeJcT9NilwrjJqymfcSY+tDwNY38E
+X9fuWr1IHMpMOj7oGbkX3JQ+5pS/DT0na0WCBOkz4MYviSiDd5YyX/i5aJZ6FJZ
iLSCbUVMCpUNQOT7hA49+sQfrsdhSVN3PS6z3UMGkW/bDsYXksZmZeJ8oOMZzj6w
LmMGoBMqNsTsMA+7jLSBS+WFZ9vPOH/D06IISG8FYDTjlSghb2oTRbCUjG/66ZVW
AkUv2gUUBNeokaiv6EAX3WccuFGmgsM2Ps48j2L3C87eXh72tmUABoKm/1CpeHWO
VfM8a5jSKjyvoxYDFF3H8+li44OAO4u9eA8MxzjCxecYexOLen5+7OIJC7ZLFgT1
ih0JbLPEaFayKuzMtJuIj+tsQCYN07meLs31fUzq3VuGcoZQkxdz997zXWoCAECV
CGnouiIzjEXGN9HPAgMBAAGjXTBbMB0GA1UdDgQWBBQ1RR9H9k/9Zjgr+E+YSyyA
XiaI8DAfBgNVHSMEGDAWgBQ1RR9H9k/9Zjgr+E+YSyyAXiaI8DAMBgNVHRMEBTAD
AQH/MAsGA1UdDwQEAwIBBjANBgkqhkiG9w0BAQsFAAOCAgEAUzIWJIaARHV1taPX
p/dYAQux3td/MPY+jud5BojKMgvj6KOcCou2FXl5de+QTz58TXJZDkEP9/pqL20a
c5uRZSzqF9FuO0XJvmVo10j8RiJypm8YA8CV8XI37RsgUf2tZW0o+wvbZvxiozY6
3OshxLDBUo5fuIHJYhfP9Oc/gKI0XGgfzGFlYusEwjd2Hpma063s6QeDBHePmrTq
no3dW5cxFK+nz+0dYQtDso82H2ctbjngeVDPnv7J2DzDGqwzuY6zIDr9mLcpbOQr
X7C7FZ+f8gEHBmW7ETYVG/5qhUMoL1r0Ilt7Yj5YHrYhEnAiPsxzIxd0Hbtn4XFO
Jc2Zd/WeckCgu0Dklx4+ohYv4vrHWvc241TLRa7G82rioktSzJBNPNPK5Lx6v+q3
M2ZGbUsWKU3UMuMC/3AjwhRZ2uJ41XBl1jajYrg7YCTh6a9uW3vM0ZUcWpsErcJh
zStA5zngKxCYXYAOtaRDhC2tIiHKnXJgRPK1oIlSX0gxXBC7CVEu+aFAlPu/TybA
+Dy7Nx8zFUq1IcXXKBPcygDeQDdg6Km1USiIRzVKmTJcLps28g+24PGdA8rMdxSw
yJ3/iJwjIbFvePGVvQrgXtwMdvo9pPdAwNS1LgxMlVqGRcadizXaea5O9WNU45ry
+e+RgGiIPUpHmwOJurId7m1Lk6s=
-----END CERTIFICATE-----
EOF2

update-ca-certificates

sleep 1
EOF
)
id=$(docker run -d $IMAGE /bin/bash -e -c "$COMMAND")

docker attach $id
test $(docker wait $id) -eq 0

docker commit $id $IMAGE > /dev/null

